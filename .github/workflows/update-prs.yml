name: Update Open Source PRs on Profile

on:
  schedule:
    - cron: "0 3 * * *" # daily 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4
      
      - name: Fetch top 6 merged PRs from unique public repos
        env:
          GITHUB_TOKEN: ${{ secrets.LATEST_PRS }}
          GH_USER: Utkarsh-Singhal-26
        run: |
          echo "Fetching merged PRs from unique public repos by $GH_USER..."
          # Fetch more PRs initially to ensure we get 6 unique repos
          gh search prs \
            --author="$GH_USER" \
            --merged \
            --visibility=public \
            --limit 50 \
            --sort=created \
            --order=desc \
            --json repository,number,createdAt \
            --jq 'group_by(.repository.nameWithOwner) | map(.[0]) | sort_by(.createdAt) | reverse | limit(6; .[]) | "- \(.repository.nameWithOwner)#\(.number)"' > prs.md
      
      - name: Update README
        run: |
          awk '
          BEGIN {in_block=0}
          /<!-- START_LATEST_PRS -->/ {print; system("cat prs.md"); in_block=1; next}
          /<!-- END_LATEST_PRS -->/ {in_block=0}
          !in_block {print}
          ' README.md > README.tmp && mv README.tmp README.md
      
      - name: Commit and push changes
        env:
          PAT: ${{ secrets.LATEST_PRS }}
        run: |
          git config user.name "Utkarsh-Singhal-26"
          git config user.email "singhalutkarsh26@gmail.com"
          git add README.md
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update top 6 merged open source PRs from unique repos in README"
          git push https://$PAT@github.com/${{ github.repository }}.git
