name: Update Open Source PRs on Profile
on:
  schedule:
    - cron: "0 3 * * *" # daily 3:00 UTC
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4
      
      - name: Fetch top 5 merged PRs from public repos
        env:
          GITHUB_TOKEN: ${{ secrets.LATEST_PRS }}
          GH_USER: Utkarsh-Singhal-26
        run: |
          echo "Fetching top 5 merged PRs from public repos by $GH_USER..."
          gh search prs \
            --author="$GH_USER" \
            --merged \
            --visibility=public \
            --limit 5 \
            --sort=created \
            --order=desc \
            --json repository,number \
            --jq -r '.[] | "\(.repository.nameWithOwner)#\(.number)"' > prs.md
      
      - name: Update README
        run: |
          awk '
          BEGIN {in_block=0}
          /<!-- START_LATEST_PRS -->/ {print; system("cat prs.md"); in_block=1; next}
          /<!-- END_LATEST_PRS -->/ {in_block=0}
          !in_block {print}
          ' README.md > README.tmp && mv README.tmp README.md
      
      - name: Commit and push changes
        env:
          PAT: ${{ secrets.LATEST_PRS }}
        run: |
          git config user.name "Utkarsh-Singhal-26"
          git config user.email "singhalutkarsh26@gmail.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "Update top 5 merged open source PRs in README"
          git push https://$PAT@github.com/${{ github.repository }}.git
